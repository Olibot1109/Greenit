<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Greenit - Quiz Arena</title>
<style>
:root{--bg:#0b1022;--card:#111833;--line:#2c3f76;--text:#eef3ff;--muted:#9bb0de;--accent:#4f7dff;--accent2:#28c2a7;--gold:#ffdf4d}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui;background:radial-gradient(circle at top,#172f66,#0b1022 65%);color:var(--text)}
.wrap{max-width:1160px;margin:auto;padding:24px}.top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.tag{padding:6px 10px;border-radius:999px;background:#1b2550;color:var(--muted);font-weight:700;font-size:12px}
.card{background:linear-gradient(180deg,#141d3c,#101732);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 12px 28px #0006;margin-top:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}.hidden{display:none}
button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;transition:transform .1s ease,filter .2s}
button:hover{filter:brightness(1.08)}button:active{transform:translateY(1px)}button.alt{background:#283b71}button.sub{background:#1a264f}
input,textarea,select{background:#0c1330;color:#fff;border:1px solid #2c3f76;padding:10px;border-radius:10px}
textarea{width:100%;min-height:84px;resize:vertical}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}.blook{padding:8px;border:1px solid #334d8f;border-radius:10px;cursor:pointer;text-align:center;background:#0e1735}
.blook img{height:58px}.status{min-height:24px;color:#9ec0ff}.player{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #263665;gap:8px}
.player:last-child{border-bottom:0}.gold{color:var(--gold);font-weight:700}.answer{width:100%;text-align:left;margin:6px 0;background:#1a295b}
.columns{display:grid;grid-template-columns:1.3fr .9fr;gap:14px}@media (max-width:900px){.columns{grid-template-columns:1fr}}
.small{font-size:13px;color:var(--muted)}
</style>
</head>
<body><div class="wrap">
<div class="top"><h1>üü© Greenit Quiz Arena</h1><span class="tag">Remote source: Open Trivia DB + Local custom sets</span></div>
<div id="home" class="card"><p>Choose a role:</p><div class="row"><button id="goHost">Host Game</button><button id="goJoin" class="alt">Join Game</button></div></div>
<div id="host" class="card hidden">
  <h2>Host Setup</h2><div class="row"><button id="backFromHost" class="alt">Back</button></div>
  <div class="columns">
    <div>
      <h3>1) Pick a set</h3>
      <div class="row"><input id="searchSets" placeholder="Search sets"/><button id="runSearch">Search</button></div>
      <div id="setResults"></div>
      <p class="small">Or create your own local custom game and save it in this browser.</p>
      <input id="customTitle" placeholder="Custom set title"/>
      <textarea id="customQuestions" placeholder='One per line:\nQuestion?|A|B|C|D|correct_index(0-3)'></textarea>
      <div class="row"><button id="saveCustom" class="sub">Save custom set locally</button><button id="loadCustom" class="sub">Use saved set</button></div>
    </div>
    <div>
      <h3>2) Game mode</h3>
      <div class="row"><select id="gameType"><option value="question">Question count mode</option><option value="timed">Time attack mode</option></select></div>
      <div class="row"><input id="questionLimit" type="number" min="1" max="30" value="30"/><span class="small">Questions (max 30)</span></div>
      <div class="row"><input id="timeLimit" type="number" min="30" max="900" value="120"/><span class="small">Timer seconds (timed mode)</span></div>
      <h3>3) Choose host blook</h3><div id="hostBlookGrid" class="grid"></div>
      <button id="createHostLobby">Create Lobby</button><p id="hostStatus" class="status"></p>
    </div>
  </div>
</div>
<div id="join" class="card hidden"><h2>Join Game</h2><button id="backFromJoin" class="alt">Back</button>
<div class="row"><input id="joinCode" placeholder="Code"/><input id="joinName" placeholder="Name"/></div>
<div id="joinBlookGrid" class="grid"></div><button id="joinLobby">Join</button><p id="joinStatus" class="status"></p></div>
<div id="lobby" class="card hidden"><h2>Host Lobby <span id="lobbyCode"></span></h2><p id="lobbyMeta"></p><div id="players"></div><button id="startGame">Start</button><button id="closeLobby" class="alt">Close</button><p id="startStatus" class="status"></p></div>
<div id="playerGame" class="card hidden"><h2>Player Panel</h2><p id="playerMeta"></p><div id="questionPanel"></div><p id="playerStatus" class="status"></p></div>
</div>
<script>
const views=['home','host','join','lobby','playerGame'];
let hostSelectedBlook=null,joinSelectedBlook=null,currentHostGameCode=null,lobbyPoll=null,playerPoll=null;
let currentPlayer={code:null,id:null,name:null}; let selectedSetId=null; let selectedCustomSet=null;
const hostStatus=document.getElementById('hostStatus');const joinStatus=document.getElementById('joinStatus');const startStatus=document.getElementById('startStatus');
function showView(v){views.forEach(id=>document.getElementById(id).classList.toggle('hidden',id!==v));}
async function api(url,opt){const r=await fetch(url,opt);const d=await r.json();if(!r.ok) throw new Error(d.error||'Request failed');return d;}
async function loadBlooks(){const data=await api('/api/blooks');for(const [id,onPick] of [['hostBlookGrid',b=>{hostSelectedBlook=b;hostStatus.textContent='Host blook: '+b.name;}],['joinBlookGrid',b=>{joinSelectedBlook=b;joinStatus.textContent='Join blook: '+b.name;}]]){const el=document.getElementById(id);el.innerHTML='';data.blooks.forEach(b=>{const c=document.createElement('div');c.className='blook';c.innerHTML='<img src="'+b.imageUrl+'"/><div>'+b.name+'</div><small>'+b.rarity+'</small>';c.onclick=()=>onPick(b);el.appendChild(c);});}}
async function searchSets(){const q=document.getElementById('searchSets').value.trim();const data=await api('/api/quiz/search?q='+encodeURIComponent(q));const box=document.getElementById('setResults');box.innerHTML='';data.sets.forEach(set=>{const row=document.createElement('div');row.className='player';row.innerHTML='<span>'+set.title+' <small>('+set.source+')</small></span><button>Select</button>';row.querySelector('button').onclick=()=>{selectedSetId=set.id;selectedCustomSet=null;hostStatus.textContent='Selected set: '+set.title;};box.appendChild(row);});if(!data.sets.length) box.textContent='No sets found.';}
function parseCustomQuestionLines(raw){const lines=raw.split('\n').map(x=>x.trim()).filter(Boolean);const questions=[];for(const line of lines){const parts=line.split('|');if(parts.length!==6) throw new Error('Each line must have 6 fields separated by |');const [q,a,b,c,d,correctRaw]=parts;const correct=Number(correctRaw);if(!q||[a,b,c,d].some(x=>!x)||!Number.isInteger(correct)||correct<0||correct>3) throw new Error('Bad custom question format.');questions.push({q,answers:[a,b,c,d],correct});}if(!questions.length) throw new Error('Add at least one custom question.');return questions;}
function saveCustomSet(){try{const title=document.getElementById('customTitle').value.trim();if(!title) throw new Error('Custom title required.');const questions=parseCustomQuestionLines(document.getElementById('customQuestions').value);const payload={title,description:'Saved from browser localStorage',questions};localStorage.setItem('greenit.customSet',JSON.stringify(payload));hostStatus.textContent='Saved custom set locally ‚úî';}catch(e){hostStatus.textContent=e.message;}}
function useSavedCustomSet(){try{const raw=localStorage.getItem('greenit.customSet');if(!raw) throw new Error('No saved custom set found.');selectedCustomSet=JSON.parse(raw);selectedSetId=null;hostStatus.textContent='Using local custom set: '+selectedCustomSet.title;}catch(e){hostStatus.textContent=e.message;}}
async function refreshLobby(){if(!currentHostGameCode)return;const data=await api('/api/games/'+currentHostGameCode+'/lobby');document.getElementById('lobbyCode').textContent=data.game.code;const s=data.game.settings;document.getElementById('lobbyMeta').textContent='Set: '+data.game.setTitle+' | '+data.game.mode+' | '+(s.gameType==='timed'?(s.timeLimitSec+'s timer'):(s.questionLimit+' questions'))+' | Host PIN: '+data.game.hostPin+' | '+data.game.state;const p=document.getElementById('players');p.innerHTML='';data.game.players.forEach(pl=>{const row=document.createElement('div');row.className='player';row.innerHTML='<span>'+pl.playerName+' ('+pl.blook.name+')</span><span class="gold">'+pl.gold+' gold</span>';p.appendChild(row);});if(!data.game.players.length)p.innerHTML='<p>Waiting for players...</p>';if(data.game.state==='live')startStatus.textContent='Live!';}
async function refreshPlayer(){if(!currentPlayer.code||!currentPlayer.id)return;const data=await api('/api/games/'+currentPlayer.code+'/player/'+currentPlayer.id);let meta=currentPlayer.name+' | Gold: '+(data.gold||0);if(typeof data.remainingSec==='number') meta+=' | ‚è± '+data.remainingSec+'s';document.getElementById('playerMeta').textContent=meta;const panel=document.getElementById('questionPanel');if(data.waiting){panel.innerHTML='<h3>Waiting for host to start...</h3>';return;}if(data.finished){panel.innerHTML='<h3>Done! Final gold: '+data.gold+' | Answered: '+(data.answered||0)+'</h3>';return;}panel.innerHTML='<h3>Q'+(data.questionIndex+1)+': '+data.question.q+'</h3><p class="small">Mode: '+(data.gameType==='timed'?'Time attack':'Question count')+' | Target: '+data.targetQuestions+' questions</p>';data.question.answers.forEach((a,i)=>{const b=document.createElement('button');b.className='answer';b.textContent=a;b.onclick=async()=>{const result=await api('/api/games/'+currentPlayer.code+'/player/'+currentPlayer.id+'/answer',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({answerIndex:i})});document.getElementById('playerStatus').textContent=result.correct?'‚úÖ Correct! +'+result.gained+' gold':'‚ùå Wrong answer';await refreshPlayer();};panel.appendChild(b);});}

document.getElementById('goHost').onclick=()=>showView('host');document.getElementById('goJoin').onclick=()=>showView('join');document.getElementById('backFromHost').onclick=()=>showView('home');document.getElementById('backFromJoin').onclick=()=>showView('home');
document.getElementById('runSearch').onclick=searchSets;document.getElementById('saveCustom').onclick=saveCustomSet;document.getElementById('loadCustom').onclick=useSavedCustomSet;
document.getElementById('createHostLobby').onclick=async()=>{try{if(!hostSelectedBlook)throw new Error('Pick a host blook.');if(!selectedSetId&&!selectedCustomSet)throw new Error('Select a set or load your custom set.');const gameType=document.getElementById('gameType').value;const questionLimit=Number(document.getElementById('questionLimit').value||30);const timeLimitSec=Number(document.getElementById('timeLimit').value||120);const body={setId:selectedSetId,customSet:selectedCustomSet,hostBlook:hostSelectedBlook,gameType,questionLimit,timeLimitSec};const data=await api('/api/host',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});currentHostGameCode=data.game.code;showView('lobby');startStatus.textContent='Lobby ready. Players wait until start.';await refreshLobby();if(lobbyPoll)clearInterval(lobbyPoll);lobbyPoll=setInterval(refreshLobby,1500);}catch(e){hostStatus.textContent=e.message;}};
document.getElementById('joinLobby').onclick=async()=>{try{const code=document.getElementById('joinCode').value.trim().toUpperCase();const name=document.getElementById('joinName').value.trim();if(!joinSelectedBlook)throw new Error('Pick a blook to join.');const data=await api('/api/games/'+code+'/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerName:name,blook:joinSelectedBlook})});currentPlayer={code,id:data.player.playerId,name:data.player.playerName};showView('playerGame');joinStatus.textContent='';await refreshPlayer();if(playerPoll)clearInterval(playerPoll);playerPoll=setInterval(refreshPlayer,1200);}catch(e){joinStatus.textContent=e.message;}};
document.getElementById('startGame').onclick=async()=>{try{const data=await api('/api/games/'+currentHostGameCode+'/start',{method:'POST'});startStatus.textContent=data.message;await refreshLobby();}catch(e){startStatus.textContent=e.message;}};
document.getElementById('closeLobby').onclick=async()=>{if(!currentHostGameCode)return showView('home');await fetch('/api/games/'+currentHostGameCode,{method:'DELETE'});currentHostGameCode=null;if(lobbyPoll)clearInterval(lobbyPoll);showView('home');};
loadBlooks();searchSets();
</script></body></html>